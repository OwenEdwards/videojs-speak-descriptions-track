{"version":3,"sources":["node_modules/browser-pack/_prelude.js","node_modules/global/window.js","src/js/index.js"],"names":["f","exports","module","define","amd","g","window","global","self","this","videojsSpeakDescriptionsTrack","r","e","n","t","o","i","c","require","u","a","Error","code","p","call","length","1","win","_interopDefault","ex","_typeof","videojs","extendedPlayerState","unknown","initialized","playing","paused","playingExtended","pausedExtended","SpeakDescriptionsTrackTTS","player","_classCallCheck","player_","extendedPlayerState_","isDucked","speechSynthesis","cancel","textTrackDisplay","getChild","updateForTrack","originalUpdateForTrack","track","getAttribute","setAttribute","bind","resume","speaking","pause","tracks","textTracks","descriptionsTrack","mode","kind","speakActiveCues","SpeechSynthesisUtterance","textToSpeak","startTime","Infinity","endTime","ct","currentTime","activeCues","push","text","Math","min","max","join","replace","log","descriptionExtended","tech_","warn","ssu","lang","increaseLanguageLocalization","language","rate","pitch","volume","onstart","onend","delta","Date","now","startDate","toFixed","play","onerror","speak","playerLanguage","navigatorLanguage","navigator","toLowerCase","indexOf","speakDescriptionsTrack","tech","speakDescriptionsTTS","on","textTrackChange","dispose","setSource","srcObj","next","setTech","newTech","off","handleTechPause_","event","duration","dur","setCurrentTime","vol","setVolume","callPlay","handleTechPlay_","middleware","TERMINATOR","callPause","use","VERSION"],"mappings":"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","file":"/Users/owen/Dropbox/ICTAS/Projects/videojs-speak-descriptions-track/dist/browser/videojs-speak-descriptions-track.min.js","sourceRoot":"","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","var win;\n\nif (typeof window !== \"undefined\") {\n    win = window;\n} else if (typeof global !== \"undefined\") {\n    win = global;\n} else if (typeof self !== \"undefined\"){\n    win = self;\n} else {\n    win = {};\n}\n\nmodule.exports = win;\n","'use strict';\n\nfunction _interopDefault (ex) { return (ex && (typeof ex === 'object') && 'default' in ex) ? ex['default'] : ex; }\n\nvar videojs = _interopDefault(require('video.js'));\nvar window = _interopDefault(require('global/window'));\n\n/**\n * Player status for extended descriptions (playback of descriptions while pausing the tech)\n *\n * @typedef extendedPlayerState\n * @enum\n */\nconst extendedPlayerState = {\n  unknown: 'unknown',\n  initialized: 'initialized',\n  playing: 'playing',\n  paused: 'paused',\n  playingExtended: 'playingExtended',\n  pausedExtended: 'pausedExtended'\n};\n\n// TODO: user control over this attribute?\nconst audioDuckingFactor = 0.25;\n\n/**\n * The SpeakDescriptionsTrackTTS component\n */\nclass SpeakDescriptionsTrackTTS {\n  /**\n   * Creates an instance of this class.\n   *\n   * @param {Player} player\n   *        The `Player` that this class should be attached to.\n   */\n  constructor(player) {\n    this.player_ = player;\n    this.extendedPlayerState_ = extendedPlayerState.initialized;\n    this.isDucked = false;\n\n    if (window.speechSynthesis) {\n      window.speechSynthesis.cancel();\n\n      // Stop the textTrackDisplay component's element from having\n      //  aria-live=\"assertive\".\n      let textTrackDisplay = player.getChild('textTrackDisplay');\n      if (textTrackDisplay && textTrackDisplay.updateForTrack) {\n        textTrackDisplay.originalUpdateForTrack = textTrackDisplay.updateForTrack;\n        textTrackDisplay.updateForTrack = function(track) {\n          if (this.getAttribute('aria-live') !== 'off') {\n            this.setAttribute('aria-live', 'off');\n          }\n          this.originalUpdateForTrack(track);\n        }.bind(textTrackDisplay);\n      }\n    }\n  }\n\n  /**\n   * Dispose of the `SpeakDescriptionsTrackTTS`\n   */\n  dispose() {\n  }\n\n  play() {\n    const speechSynthesis = window.speechSynthesis;\n\n    if (speechSynthesis.paused) {\n      speechSynthesis.resume();\n    }\n  }\n\n  pause() {\n    const speechSynthesis = window.speechSynthesis;\n\n    if (speechSynthesis.speaking) {\n      speechSynthesis.pause();\n    }\n  }\n\n  paused() {\n    return (\n      this.extendedPlayerState_ === extendedPlayerState.paused ||\n      this.extendedPlayerState_ === extendedPlayerState.pausedExtended\n    );\n  }\n\n  textTrackChange() {\n    const tracks = this.player_.textTracks();\n    let descriptionsTrack = null;\n    let i = tracks.length;\n\n    while (i--) {\n      const track = tracks[i];\n\n      if (track.mode === 'showing') {\n        if (track.kind === 'descriptions') {\n          descriptionsTrack = track;\n        }\n      }\n    }\n\n    if (descriptionsTrack) {\n      this.speakActiveCues(descriptionsTrack);\n    }\n  }\n\n  /**\n   * Use browser Speech Synthesis (aka TTS) to speak active cues, if supported\n   *\n   * @param {TextTrackObject} track Texttrack object to speak\n   * @method speakActiveCues\n   */\n  speakActiveCues(track) {\n    if (!window.SpeechSynthesisUtterance || !window.speechSynthesis) {\n      return;\n    }\n\n    const speechSynthesis = window.speechSynthesis;\n\n    let textToSpeak = [];\n    let startTime = Infinity;\n    let endTime = -Infinity;\n    const ct = this.player_.currentTime();\n\n    if (track.activeCues) {\n      // TODO: Need to handle this logic better; it's possible that a new cue\n      //       started while another is still active. We don't handle that correctly.\n      for (let i = 0; i < track.activeCues.length; i++) {\n        textToSpeak.push(track.activeCues[i].text);\n        startTime = Math.min(track.activeCues[i].startTime, startTime);\n        endTime = Math.max(track.activeCues[i].endTime, endTime);\n      }\n      // TODO: handle any HTML markup in the cues properly; for now,\n      //       we just strip out HTML markup.\n      textToSpeak = textToSpeak.join('\\r\\n').replace(/<(?:.|\\n)*?>/gm, '');\n    }\n\n    if (textToSpeak) {\n      if (speechSynthesis.speaking) {\n        // TODO: Handle description cue collision\n        videojs.log.warn(`Speech synthesis collision (${textToSpeak} - ${this.ssu.text}) : ${ct} : ${this.startTime} : ${this.endTime}`);\n\n        speechSynthesis.cancel();\n\n      } else if (speechSynthesis.paused) {\n        // TODO: Handle if speech synthesis is paused here\n        videojs.log.warn(`Speech synthesis collision (paused) (${textToSpeak} - ${this.ssu.text}) : ${ct} : ${this.startTime} : ${this.endTime}`);\n\n        speechSynthesis.cancel();\n        speechSynthesis.resume();\n      }\n\n      // Store info about the current cue for debugging and/or logging\n      this.startTime = startTime;\n      this.endTime = endTime;\n\n      // TODO: Need to dispose of this ssu after it is finished?\n      this.ssu = new window.SpeechSynthesisUtterance();\n\n      this.ssu.text = textToSpeak;\n      this.ssu.lang = this.increaseLanguageLocalization(track.language);\n\n      // TODO: user control over these attributes\n      this.ssu.rate = 1.1;\n      this.ssu.pitch = 1.0;\n      this.ssu.volume = 1.0;\n\n      // TODO: This audio ducking needs to be made more robust\n      this.ssu.onstart = function(e) {\n        // Duck the player's audio\n        if (!this.isDucked) {\n          this.isDucked = true;\n          this.player_.tech_.volume(this.player_.tech_.volume() * audioDuckingFactor);\n        }\n      }.bind(this);\n      this.ssu.onend = function(e) {\n        // Speech synthesis of a cue has ended\n\n        const delta = (Date.now() - this.ssu.startDate) / 1000;\n\n        videojs.log(`SpeakDescriptionsTrackTTS of cue: ${this.startTime} : ${this.endTime} : ${this.endTime - this.startTime} : ${delta} : ${(delta * 100.0 / (this.endTime - this.startTime)).toFixed(1)}%`);\n\n        // Un-duck the player's audio\n        if (this.isDucked) {\n          this.isDucked = false;\n          this.player_.tech_.volume(this.player_.tech_.volume() / audioDuckingFactor);\n        }\n\n        if (this.extendedPlayerState_ === extendedPlayerState.playingExtended) {\n          videojs.log('Un-pausing playback');\n          this.extendedPlayerState_ = extendedPlayerState.playing;\n          this.player_.tech_.play();\n          this.descriptionExtended = false;\n        }\n      }.bind(this);\n      this.ssu.onerror = function(e) {\n        // An error occured during speech synthesis\n\n        const delta = (Date.now() - this.ssu.startDate) / 1000;\n\n        videojs.log.warn(`SSU error (${this.ssu.text})`);\n        videojs.log.warn(`SpeakDescriptionsTrackTTS of cue: ${this.startTime} : ${this.endTime} : ${this.endTime - this.startTime} : ${delta} : ${(delta * 100.0 / (this.endTime - this.startTime)).toFixed(1)}%`);\n\n        // Un-duck the player's audio\n        if (this.isDucked) {\n          this.isDucked = true;\n          this.player_.tech_.volume(this.player_.tech_.volume() / audioDuckingFactor);\n        }\n\n        if (this.extendedPlayerState_ === extendedPlayerState.playingExtended) {\n          videojs.log('Un-pausing playback');\n          this.extendedPlayerState_ = extendedPlayerState.playing;\n          this.player_.tech_.play();\n          this.descriptionExtended = false;\n        }\n      }.bind(this);\n\n      // Start speaking the new textToSpeak\n\n      this.ssu.startDate = Date.now();\n      speechSynthesis.speak(this.ssu);\n\n    } else {\n      // No current textToSpeak, so a cue's display time has ended.\n\n      if (speechSynthesis.speaking) {\n        // Speech synthesis is still speaking - handle description cue overrun\n        videojs.log('Pausing playback');\n\n        this.extendedPlayerState_ = extendedPlayerState.playingExtended;\n        this.descriptionExtended = true;\n        this.player_.tech_.pause();\n\n      } else if (speechSynthesis.paused) {\n        // TODO: Handle if speech synthesis is paused here\n        videojs.log.warn(`Speech synthesis overrun (paused) (${this.ssu.text}) : ${this.startTime} : ${this.endTime}`);\n\n        speechSynthesis.cancel();\n        speechSynthesis.resume();\n\n   // } else if (this.ssu) {\n     // videojs.log(`Speech had ended before end of cue (${this.ssu.text}) : ${this.startTime} : ${this.endTime} : ${ct}`);\n\n      }\n\n      return;\n    }\n  }\n\n  /**\n   * Try to improve the localization of the text track language, using\n   *  the player's language setting and the browser's language setting.\n   *  e.g. if lang='en' and language = 'en-US', use the more specific\n   *  localization of language.\n   *\n   * @param {string} lang the lang attribute to try to improve\n   * @return {string} the improved lang attribute\n   * @method increaseLanguageLocalization\n   */\n  increaseLanguageLocalization(lang) {\n    const playerLanguage = this.player_.language && this.player_.language();\n    const navigatorLanguage = window.navigator && window.navigator.language;\n\n    if (\n      lang &&\n      (typeof lang === 'string') &&\n      (typeof playerLanguage === 'string') &&\n      (playerLanguage.length > lang.length) &&\n      (playerLanguage.toLowerCase().indexOf(lang.toLowerCase()) === 0)\n    ) {\n\n      lang = playerLanguage;\n    }\n\n    if (\n      lang &&\n      (typeof lang === 'string') &&\n      (typeof navigatorLanguage === 'string') &&\n      (navigatorLanguage.length > lang.length) &&\n      (navigatorLanguage.toLowerCase().indexOf(lang.toLowerCase()) === 0)\n    ) {\n\n      lang = navigatorLanguage;\n    }\n\n    return lang;\n  }\n}\n\nconst speakDescriptionsTrack = function(player) {\n  let tech;\n\n  player.speakDescriptionsTTS = new SpeakDescriptionsTrackTTS(player);\n  player.on('texttrackchange', player.speakDescriptionsTTS.textTrackChange.bind(player.speakDescriptionsTTS));\n  player.on('dispose', player.speakDescriptionsTTS.dispose.bind(player.speakDescriptionsTTS));\n\n  return {\n    setSource(srcObj, next) {\n      next(null, srcObj);\n    },\n\n    setTech(newTech) {\n      tech = newTech;\n\n      player.off(tech, 'pause', player.handleTechPause_);\n\n      tech.on('pause', (event) => {\n        if (player.speakDescriptionsTTS && player.speakDescriptionsTTS.extendedPlayerState_) {\n          if (player.speakDescriptionsTTS.extendedPlayerState_ !== extendedPlayerState.playingExtended) {\n            player.handleTechPause_();\n          }\n        }\n      });\n    },\n\n    // TODO: Eventually we may modify the duration and/or current time to allow\n    //       for the time that the video is paused for extended description.\n    //       For now, we just treat it as though the video stalled while streaming.\n    duration(dur) {\n      return dur;\n    },\n\n    currentTime(ct) {\n      return ct;\n    },\n\n    setCurrentTime(ct) {\n      return ct;\n    },\n\n    volume(vol) {\n      if (player.speakDescriptionsTTS && player.speakDescriptionsTTS.isDucked) {\n        return vol / audioDuckingFactor;\n      }\n\n      return vol;\n    },\n\n    setVolume(vol) {\n      if (player.speakDescriptionsTTS && player.speakDescriptionsTTS.isDucked) {\n        return vol * audioDuckingFactor;\n      }\n\n      return vol;\n    },\n\n    paused() {\n      if (player.speakDescriptionsTTS) {\n        return player.speakDescriptionsTTS.paused();\n      }\n    },\n\n    callPlay() {\n      if (!player.speakDescriptionsTTS) {\n        return;\n      }\n\n      if (!player.speakDescriptionsTTS.extendedPlayerState_) {\n        player.speakDescriptionsTTS.extendedPlayerState_ = extendedPlayerState.unknown;\n      }\n\n      switch (player.speakDescriptionsTTS.extendedPlayerState_) {\n      case extendedPlayerState.unknown:\n      case extendedPlayerState.initialized:\n      case extendedPlayerState.paused:\n        player.speakDescriptionsTTS.extendedPlayerState_ = extendedPlayerState.playing;\n        player.speakDescriptionsTTS.play();\n        return;\n\n      case extendedPlayerState.pausedExtended:\n        player.speakDescriptionsTTS.extendedPlayerState_ = extendedPlayerState.playingExtended;\n        player.speakDescriptionsTTS.play();\n        player.handleTechPlay_();\n        return videojs.middleware.TERMINATOR;\n      }\n\n      return;\n    },\n\n    callPause() {\n      if (!player.speakDescriptionsTTS) {\n        return;\n      }\n\n      if (!player.speakDescriptionsTTS.extendedPlayerState_) {\n        player.speakDescriptionsTTS.extendedPlayerState_ = extendedPlayerState.unknown;\n      }\n\n      switch (player.speakDescriptionsTTS.extendedPlayerState_) {\n      case extendedPlayerState.unknown:\n      case extendedPlayerState.initialized:\n      case extendedPlayerState.playing:\n        player.speakDescriptionsTTS.extendedPlayerState_ = extendedPlayerState.paused;\n        player.speakDescriptionsTTS.pause();\n        return;\n\n      case extendedPlayerState.playingExtended:\n        player.speakDescriptionsTTS.extendedPlayerState_ = extendedPlayerState.pausedExtended;\n        player.speakDescriptionsTTS.pause();\n        player.handleTechPause_();\n        return videojs.middleware.TERMINATOR;\n      }\n\n      return;\n    }\n  };\n};\n\n// Register the plugin with video.js.\nvideojs.use('*', speakDescriptionsTrack);\n\n// Include the version number.\nspeakDescriptionsTrack.VERSION = '__VERSION__';\n\nmodule.exports = speakDescriptionsTrack;\n"]}