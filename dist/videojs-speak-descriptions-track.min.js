/*! @name videojs-speak-descriptions-track @version 1.6.0 @license MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js"),require("global/window")):"function"==typeof define&&define.amd?define(["video.js","global/window"],t):(e=e||self).videojsSpeakDescriptionsTrack=t(e.videojs,e.window)}(this,function(e,t){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var s={unknown:"unknown",initialized:"initialized",playing:"playing",paused:"paused",playingExtended:"playingExtended",pausedExtended:"pausedExtended"},i=function(){function i(e){if(this.player_=e,this.extendedPlayerState_=s.initialized,this.isDucked=!1,this.originalSpeechRate=1.1,this.speechRate=this.originalSpeechRate,t.speechSynthesis){t.addEventListener("unload",function(){t.speechSynthesis.cancel(),t.speechSynthesis.resume()});var i=e.getChild("textTrackDisplay");i&&i.updateForTrack&&(i.originalUpdateForTrack=i.updateForTrack,i.updateForTrack=function(e){"off"!==this.getAttribute("aria-live")&&this.setAttribute("aria-live","off"),this.originalUpdateForTrack(e)}.bind(i))}}var a=i.prototype;return a.voice=function(e){if(void 0===e&&this.voice_)return this.voice_;if("[object SpeechSynthesisVoice]"!==Object.prototype.toString.call(e)){this.voice_=null;var s=this.ssu&&this.ssu.lang||this.increaseLanguageLocalization(this.player_.language());return t.speechSynthesis.getVoices().filter(function(e){return e.lang.startsWith(s)})[0]}return this.voice_=e,this.voice_},a.dispose=function(){},a.play=function(){t.speechSynthesis.resume()},a.pause=function(){var e=t.speechSynthesis;e.speaking&&e.pause()},a.paused=function(){return this.extendedPlayerState_===s.paused||this.extendedPlayerState_===s.pausedExtended},a.textTrackChange=function(){for(var e=this.player_.textTracks(),t=null,s=e.length;s--;){var i=e[s];"showing"===i.mode&&"descriptions"===i.kind&&(t=i)}t&&this.speakActiveCues(t)},a.speakActiveCues=function(i){if(t.SpeechSynthesisUtterance&&t.speechSynthesis){var a=t.speechSynthesis,n=[],r=1/0,o=-1/0,c=this.player_.currentTime();if(i.activeCues){for(var p=0;p<i.activeCues.length;p++)n.push(i.activeCues[p].text),r=Math.min(i.activeCues[p].startTime,r),o=Math.max(i.activeCues[p].endTime,o);n=n.join(" ").replace(/<(?:.|\n)*?>/gm,"")}n?(a.speaking?(e.log.warn("Speech synthesis collision ("+n+" - "+this.ssu.text+") : "+c+" : "+this.startTime+" : "+this.endTime),a.cancel()):a.paused&&(e.log.warn("Speech synthesis collision (paused) ("+n+" - "+this.ssu.text+") : "+c+" : "+this.startTime+" : "+this.endTime),a.cancel(),a.resume()),this.startTime=r,this.endTime=o,this.ssu=new t.SpeechSynthesisUtterance,this.ssu.text=n,this.ssu.lang=this.increaseLanguageLocalization(i.language),this.ssu.voice=this.voice(),this.ssu.rate=this.player_.playbackRate()*this.speechRate,this.ssu.pitch=1,this.ssu.volume=this.player_.volume(),this.ssu.onstart=this.duck.bind(this),this.ssu.onend=function(t){var s=(Date.now()-this.ssu.startDate)/1e3;this.log({delta:s});var i=s/(this.endTime-this.startTime);if(i>1){var a=this.speechRate*Math.sqrt(i);e.log("Adjusting speech rate UP from "+this.speechRate+" to "+a),this.speechRate=a}else if(i<.9&&this.speechRate>this.originalSpeechRate){var n=(this.speechRate+this.originalSpeechRate)/2;e.log("Adjusting speech rate DOWN from "+this.speechRate+" to "+n),this.speechRate=n}this.utteranceFinished()}.bind(this),this.ssu.onerror=function(t){var s=(Date.now()-this.ssu.startDate)/1e3;e.log.warn("SSU error ("+this.ssu.text+")"),this.log({delta:s,warn:!0}),this.utteranceFinished()}.bind(this),this.ssu.startDate=Date.now(),a.speak(this.ssu)):a.speaking?(e.log("Pausing playback"),this.extendedPlayerState_=s.playingExtended,this.descriptionExtended=!0,this.player_.tech_.pause()):a.paused&&(e.log.warn("Speech synthesis overrun (paused) ("+this.ssu.text+") : "+this.startTime+" : "+this.endTime),a.cancel(),a.resume())}},a.increaseLanguageLocalization=function(e){var s=this.player_.language&&this.player_.language(),i=t.navigator&&t.navigator.language;return e&&"string"==typeof e&&"string"==typeof s&&s.length>e.length&&0===s.toLowerCase().indexOf(e.toLowerCase())&&(e=s),e&&"string"==typeof e&&"string"==typeof i&&i.length>e.length&&0===i.toLowerCase().indexOf(e.toLowerCase())&&(e=i),e},a.log=function(t){var s=t.delta,i=t.warn,a=void 0!==i&&i?e.log.warn:e.log;a("SpeakDescriptionsTrackTTS of cue: "+this.startTime+" : "+this.endTime+" : "+(this.endTime-this.startTime)+" : "+s+" : "+(100*s/(this.endTime-this.startTime)).toFixed(1)+"%")},a.duck=function(){this.isDucked||(this.isDucked=!0,this.player_.addClass("vjs-audio-ducked"),this.player_.tech_.setVolume(.25*this.player_.tech_.volume()))},a.unduck=function(){this.isDucked&&(this.isDucked=!1,this.player_.removeClass("vjs-audio-ducked"),this.player_.tech_.setVolume(this.player_.tech_.volume()/.25))},a.utteranceFinished=function(){this.unduck(),this.extendedPlayerState_===s.playingExtended&&(e.log("Un-pausing playback"),this.extendedPlayerState_=s.playing,this.player_.tech_.play(),this.descriptionExtended=!1)},i}(),a=function(t){var a;return t.speakDescriptionsTTS=new i(t),t.on("texttrackchange",t.speakDescriptionsTTS.textTrackChange.bind(t.speakDescriptionsTTS)),t.on("dispose",t.speakDescriptionsTTS.dispose.bind(t.speakDescriptionsTTS)),{setSource:function(e,t){t(null,e)},setTech:function(e){a=e,t.off(a,"pause",t.handleTechPause_),a.on("pause",function(e){t.speakDescriptionsTTS&&t.speakDescriptionsTTS.extendedPlayerState_&&t.speakDescriptionsTTS.extendedPlayerState_!==s.playingExtended&&t.handleTechPause_()})},duration:function(e){return e},currentTime:function(e){return e},setCurrentTime:function(e){return e},volume:function(e){return t.speakDescriptionsTTS&&t.speakDescriptionsTTS.isDucked?e/.25:e},setVolume:function(e){return t.speakDescriptionsTTS&&t.speakDescriptionsTTS.isDucked?.25*e:e},paused:function(){if(t.speakDescriptionsTTS)return t.speakDescriptionsTTS.paused()},callPlay:function(){if(t.speakDescriptionsTTS)switch(t.speakDescriptionsTTS.extendedPlayerState_||(t.speakDescriptionsTTS.extendedPlayerState_=s.unknown),t.speakDescriptionsTTS.extendedPlayerState_){case s.unknown:case s.initialized:case s.paused:return t.speakDescriptionsTTS.extendedPlayerState_=s.playing,void t.speakDescriptionsTTS.play();case s.pausedExtended:return t.speakDescriptionsTTS.extendedPlayerState_=s.playingExtended,t.speakDescriptionsTTS.play(),t.handleTechPlay_(),e.middleware.TERMINATOR}},callPause:function(){if(t.speakDescriptionsTTS)switch(t.speakDescriptionsTTS.extendedPlayerState_||(t.speakDescriptionsTTS.extendedPlayerState_=s.unknown),t.speakDescriptionsTTS.extendedPlayerState_){case s.unknown:case s.initialized:case s.playing:return t.speakDescriptionsTTS.extendedPlayerState_=s.paused,void t.speakDescriptionsTTS.pause();case s.playingExtended:return t.speakDescriptionsTTS.extendedPlayerState_=s.pausedExtended,t.speakDescriptionsTTS.pause(),t.handleTechPause_(),e.middleware.TERMINATOR}}}};return a.VERSION="1.6.0",e.use("*",a),a});
